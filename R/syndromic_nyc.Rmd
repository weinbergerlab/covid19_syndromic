---
title: "covid_19_syndromic"
author: "Dan Weinberger"
date: "3/8/2020"
output: html_document
---

The goal of these analyses is to detect increases in syndromic disease activity associated with  COVID-19. As a test, we are using syndromic disease data from New York City. Data are stratified by day, borrough, age group. the data were downloaded from the [Epiquery website](https://a816-health.nyc.gov/hdi/epiquery/visualizations?PageType=ps&PopulationSource=Syndromic)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("..")) #sets Working directory to be 1 folder up

library(reshape2)
library(lubridate)
library(mgcv)
library(INLA)
library(inlabru)
```

Import the data and remove the unnecesary rows. Note that the file downloads as a .csv format, but it is actually a tab-separated file.
```{r, eval=F}
ili1<- read.table('./Data/ILI_2020_3_8.csv',sep="\t", header=TRUE, skipNul = T) 
resp1<-read.table('./Data/resp_2020_3_8.csv',sep="\t", header=TRUE, skipNul = T) 

combo1<-rbind.data.frame(ili1, resp1)

names(combo1)<-c('note','syndrome','geo.level','borough','ag.level','age_group','date','metric', 'count')

combo1<-combo1[,c('syndrome','borough','age_group','date','count')]
combo1$date<-as.Date(combo1$date, '%m/%d/%y')
combo1$count<-gsub(',', '', combo1$count) #remove commas from number
combo1$count<-as.numeric(as.character(combo1$count))
saveRDS(combo1,'./Data/ili_resp.rds')
```

Read in the data
```{r}
combo1<-readRDS('./Data/ili_resp.rds')
```

```{r}
#select.syndrome<-"Respiratory"
select.syndrome<-"Influenza-like illness (ILI)"

```

Reshape the data. For now, just focus on ILI
```{r}
combo1.m<-melt(combo1[combo1$syndrome==select.syndrome,], id.vars=c('syndrome', 'borough','age_group','date'))
combo1.a<-dcast(combo1.m, date +borough+syndrome~age_group )
```


```{r}
combo1.a$"o65"<-combo1.a$`Ages 65+ years`
combo1.a$"u5"<-combo1.a$`Ages 0-4 years`
combo1.a$dow<-as.factor(weekdays(combo1.a$date))
combo1.a$epiyr<-year(combo1.a$date)
combo1.a$epiyr[month(combo1.a$date)<=6] <-combo1.a$epiyr[month(combo1.a$date)<=6]-1
combo1.a$jul1.date<-as.Date(paste(combo1.a$epiyr,'07', '01', sep='-'), )
combo1.a$day.index<- as.numeric(difftime(combo1.a$date , combo1.a$jul1.date, unit='days'))
```

```{r}
nyc<-combo1.a[combo1.a$borough=='Citywide',]
#nyc<-combo1.a[combo1.a$borough=='Manhattan',]
#nyc<-combo1.a[combo1.a$borough=='Queens',]
#nyc<-combo1.a[combo1.a$borough=='Bronx',]

```


```{r}
plot(nyc$date,nyc$"Ages 18-64 years", type='l', bty='l', main='ILI all ages in NYC')
```

```{r, fig.width=4, fig.height=6}
par(mfrow=c(2,1), mar=c(2,2,2,1))
plot(nyc$date,nyc$`Ages 0-4 years`, type='l', bty='l', main='ILI <5 years in NYC')
plot(nyc$date,nyc$`Ages 65+ years`, type='l', bty='l', main='ILI 65+ years in NYC')
```
Plot ratio of 65+ to younger age groups for ILI
```{r, fig.width=12, fig.height=4}
ages<-c("Ages 0-4 years", "Ages 5-17 years",  "Ages 18-64 years" )
plot.rat<-function(age.select){
nyc$age.rat<-(nyc$`Ages 65+ years`+0.5)/(nyc[,age.select]+0.5)
plot(nyc$date,log(nyc$age.rat), type='l', bty='l', main=paste0('ratio of 65+ and ',age.select), yaxt='n', ylab='Ratio')
axis(side=2, at=-c(-5, -0.5, 0, 0.5), label=round(exp(c(-5, -0.5, 0, 0.5)),2) )
}
par(mfrow=c(1,3))
lapply(ages, plot.rat)
```


Model with smoothing spline for year
```{r}
mod2<-gam(cbind(nyc$o65, nyc$u5)~dow+s(day.index, bs='bs'), family=binomial, data=nyc)
plot(mod2)
pred2<-predict(mod2, type='response')
raw.ratio<-(nyc$`Ages 65+ years`+0.5)/(nyc$`Ages 0-4 years`+0.5)
plot(nyc$date, pred2, type='p')
points(nyc$date,raw.ratio, col='red')
```

Disaggregated boroughs data. Fit through Jan 2020, then extrapolate seasonal baseline forward
```{r}
bur1<- combo1.a[combo1.a$borough != 'Citywide',]
bur1$borough<-factor(bur1$borough)
bur1.fit<-bur1[bur1$date<as.Date('2020-02-01'),]

mod2<-gam(cbind(bur1.fit$o65, bur1.fit$u5)~dow+s(day.index, bs='bs') +borough, family=binomial, data=bur1.fit)
pred2<-predict(mod2, newdata=bur1,type='response')
raw.ratio<-(bur1$`Ages 65+ years`+0.5)/(bur1$`Ages 0-4 years`+0.5)
plot(bur1$date, pred2, type='p')
```
Pointwise log likelihood
```{r}
log.like.mod2<- -dbinom(bur1$o65,bur1$o65+ bur1$u5,pred2, log=T)
plot(bur1$date, log.like.mod2)
abline(v=as.Date('2020-02-01'), lty=2, col='gray', bty='l')
```


```{r}
bur1.fit.alt<-bur1
bur1.fit.alt$o65.fit<-bur1.fit.alt$o65
bur1.fit.alt$o65.fit[bur1$date>=as.Date('2020-01-01')]<-NA
bur1.fit.alt$u5.fit<-bur1.fit.alt$u5
bur1.fit.alt$u5.fit[bur1$date>=as.Date('2020-01-01')]<-NA

form1<-as.formula('o65.fit ~  borough + dow +f(day.index, model = "rw1", constr = FALSE)')
m.rw1 <- inla( form1 ,   family='binomial', data=bur1.fit.alt, Ntrials= (bur1.fit.alt$u5+ bur1.fit.alt$o65.fit), 
control.predictor = list(compute = TRUE) )
summary(m.rw1)
```

Something wrong here
```{r}
pred.rw1<-m.rw1$summary.fitted.values$`0.5quant`
pred.rw1<-exp(pred.rw1)/(1+exp(pred.rw1))
plot(bur1$date, pred.rw1)
```















